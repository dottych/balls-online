let aa=window.location.host,b=document.getElementById("canvas"),c=b.getContext("2d"),ba=document.getElementById("form"),f=document.getElementById("message"),[g,h,k,n,p,r,t,u,v,w,x,y,B]=[document.getElementById("bLeft"),document.getElementById("bRight"),document.getElementById("bUp"),document.getElementById("bDown"),document.getElementById("bShift"),document.getElementById("ChatMessage"),document.getElementById("Notification"),document.getElementById("cb1"),document.getElementById("cb2"),document.getElementById("cb3"),
document.getElementById("cb4"),document.getElementById("cb5"),document.getElementById("cb6")];ba.addEventListener("submit",a=>{a.preventDefault();f.value&&(a=f.value,null!==a&&(C.send(JSON.stringify(["message",a.slice(0,128).toString()])),f.value=""))});if(0<=window.navigator.appVersion.indexOf("Android")||0<=window.navigator.appVersion.indexOf("iOS"))g.removeAttribute("hidden"),h.removeAttribute("hidden"),k.removeAttribute("hidden"),n.removeAttribute("hidden"),p.removeAttribute("hidden");
c.font="bold 16px Calibri, Carlito, sans-serif";const C=new WebSocket(`wss://${aa}`);
var D={},E=u.checked,F=v.checked,G=w.checked,H=x.checked,I=y.checked,J=B.checked,K=0,ca=0,L=0,M=0,N=!1,Q=60,R=(a,e,d,m="#FFFFFF",l=!1)=>{l&&(c.fillStyle="#00000080",c.fillRect(e-("center"==c.textAlign?c.measureText(a).width/2:0),d-12,c.measureText(a).width,16));c.font="bold 16px Calibri";c.fillStyle=m;l=c.fillStyle;let q="FF";void 0!==l[6]&&void 0!==l[7]&&(q=l[6]+l[7]);c.fillStyle=`#000000${q}`;c.fillText(a,e+1,d+1);c.fillStyle=m;c.fillText(a,e,d)},S={},T="",da=0,ea=0,U=[],V=[],W=0,X="",Y=0,fa=!1,
Z=[],ha=a=>{var e=a-K;Q=1E3/e;K=a;c.clearRect(0,0,b.width,b.height);c.fillStyle="gray";c.fillRect(0,0,b.width,b.height);[E,F,G,H,I,J]=[u.checked,v.checked,w.checked,x.checked,y.checked,B.checked];if(void 0!==U[8])for(a=0;16>a;a++)for(var d=0;9>d;d++)if(0<U[d][a])switch(U[d][a]){case 1:c.fillStyle="#858585";c.fillRect(80*a,80*d,80,80);break;case 2:c.fillStyle="#909090";c.fillRect(80*a,80*d,80,80);break;case 3:c.fillStyle="#AAAAAA",c.fillRect(80*a,80*d,80,80)}for(a=0;a<Z.length;a++)1>Z[a][2]||(c.fillStyle=
`#DDDDDD${1==Z[a][2].toString(16).length?"0"+Z[a][2].toString(16):Z[a][2].toString(16)}`,c.fillRect(Z[a][0]+4,Z[a][1]+4,8,8),Z[a][2]--);c.textAlign="center";for(a=0;a<Object.keys(S).length;a++)if(d=S[Object.keys(S)[a]],Object.keys(S)[a]!=T?c.fillStyle="#FF6969":c.fillStyle="#3369FF",Object.keys(S)[a]!=T){var m=d.g;m=Math.floor(m+Math.floor(e/1E3*200)/8*(d.x-m));var l=d.h;l=Math.floor(l+Math.floor(e/1E3*200)/8*(d.y-l));d.g=d.x;d.h=d.y;c.beginPath();c.arc(m+8,l+8,8,0,2*Math.PI);c.fill();c.closePath();
d=Object.keys(S)[a];var q=c.measureText(Object.keys(S)[a]).width/2,ja=1280-c.measureText(Object.keys(S)[a]).width/2;R(d,Math.min(Math.max(m+8,q),ja),Math.min(Math.max(l-16,16),704),"#FFFFFF",J)}else c.beginPath(),c.arc(d.x+8,d.y+8,8,0,2*Math.PI),c.fill(),c.closePath(),m=Object.keys(S)[a],l=c.measureText(Object.keys(S)[a]).width/2,q=1280-c.measureText(Object.keys(S)[a]).width/2,R(m,Math.min(Math.max(d.x+8,l),q),Math.min(Math.max(d.y-16,16),704),"#FFFFFF",J);[da,ea]=[void 0===S[T]?0:S[T].x,void 0===
S[T]?0:S[T].y];let [,,z,A,,O,P]=[0,0,0,0,0,!1,!1];a=Math.floor(e/1E3*200);e=S[T];try{if(D[37]||D.left)z=-a;if(D[39]||D.right)z=a;if(D[38]||D.j)A=-a;if(D[40]||D.i)A=a;if(e.x!==e.g)for(a=0;9>a;a++)for(d=0;16>d;d++)2<=U[a][d]&&!O&&(O=e.x+z<80*d+80&&e.x+z+16>80*d&&e.y<80*a+80&&e.y+16>80*a);if(e.y!==e.h)for(a=0;9>a;a++)for(d=0;16>d;d++)2<=U[a][d]&&!P&&(P=e.x<80*d+80&&e.x+16>80*d&&e.y+A<80*a+80&&e.y+A+16>80*a);O||(S[T].x=Math.min(Math.max(S[T].x+z,0),1264));P||(S[T].y=Math.min(Math.max(S[T].y+A,0),704));
fa=D[16]||D.shift?!0:!1}catch(la){}c.textAlign="left";R("Balls Online",16,16,"#EEEEEE");R(`FPS: ${Math.ceil(Q)}`,16,32,30>Q?15>Q?"red":"yellow":"lime",E);R(`Ping: ${isNaN(L)?0:L}ms`,16,48,100<L?250<L?"red":"yellow":"lime",E);R(`Status: ${0==C.readyState||3==C.readyState||2==C.readyState?"offline":"online"}`,16,64,0==C.readyState||3==C.readyState||2==C.readyState?"red":"lime",E);R(`Client run: ${Math.floor(K/1E3)}s`,16,96,"#AAAAFF",E);R(`Server run: ${Math.floor((ca+K)/1E3)}s`,16,112,"#AAAAFF",E);
R("Version: 0.3.3",16,144,"#AAAAFF",E);R(`Platform: ${window.navigator.platform}`,16,160,"#AAAAFF",E);R("Info",192,16,"#EEEEEE");R(`Client ID: ${T}`,192,32,"#DDDDDD",F);R(`Client X: ${Math.floor(void 0===S[T]?0:S[T].x)}`,192,48,"#DDDDDD",F);R(`Client Y: ${Math.floor(void 0===S[T]?0:S[T].y)}`,192,64,"#DDDDDD",F);R(`Players: ${Object.keys(S).length}`,192,96,"#DDDDDD",F);R("Chat",384,16,"#EEEEEE");for(e=0;e<V.length;e++)R(V[e],384,16*(e+2),e==V.length-1?`${"#DDDD"}${1==W.toString(16).length?"0"+W.toString(16):
W.toString(16)}`:"#DDDDDD",G),221>W&&W++;R("Player list",16,192,"#EEEEEE");for(e=0;e<Object.keys(S).length;e++)a=S[Object.keys(S)[e]],R(`${Object.keys(S)[e]} - ${a.x}, ${a.y}`,16,192+16*(e+1),"#DDDDDD",H);0<Y&&(R(X,(1280-c.measureText(X).width)/2,360,`#EEEEEE${255<Y?"FF":(1==Y.toString(16).length?"0":"")+Y.toString(16)}`,I),Y--);requestAnimationFrame(ha)},ia;C.addEventListener("open",()=>{console.log("Connected to server")});
C.addEventListener("message",a=>{a=JSON.parse(a.data);switch(a[0]){case "id":T=a[1];null!==window.localStorage.getItem("name")&&C.send(JSON.stringify(["message",`/name ${window.localStorage.getItem("name")}`]));break;case "time":ca=a[1];break;case "spawn":S[a[1]]={x:a[2],y:a[3],g:0,h:0};break;case "despawn":delete S[a[1]];break;case "move":S[a[1]].x=a[2];S[a[1]].y=a[3];break;case "ping":N=!1;M=0;L=Math.ceil(performance.now()-ia);break;case "map":U=a[1];break;case "message":V.push(`${a[1]}: ${a[2]}`);
5<V.length&&V.shift();W=0;r.currentTime=0;r.play();break;case "rename":let e=S[a[1]];delete S[a[1]];a[1]==T&&(T=a[2],window.localStorage.setItem("name",a[2]));S[a[2]]={x:e.x,y:e.y,g:0,h:0};break;case "restart":location.reload();break;case "notification":X=a[1];Y=510;r.pause();t.currentTime=0;t.play();break;case "draw":Z.push([a[1],a[2],255]);break;case "redirect":window.location.replace(a[1])}});window.addEventListener("keydown",a=>{D[a.keyCode]=!0});
window.addEventListener("keyup",a=>{D[a.keyCode]=!1});k.addEventListener("touchstart",()=>{D.j=!0});n.addEventListener("touchstart",()=>{D.i=!0});g.addEventListener("touchstart",()=>{D.left=!0});h.addEventListener("touchstart",()=>{D.right=!0});p.addEventListener("touchstart",()=>{D.shift=!0});k.addEventListener("touchend",()=>{D.j=!1});n.addEventListener("touchend",()=>{D.i=!1});g.addEventListener("touchend",()=>{D.left=!1});h.addEventListener("touchend",()=>{D.right=!1});
p.addEventListener("touchend",()=>{D.shift=!1});setInterval(()=>{try{C.readyState==WebSocket.CLOSED||da==S[T].x&&ea==S[T].y||(C.send(JSON.stringify(["move",S[T].x,S[T].y])),fa&&C.send(JSON.stringify(["draw"])))}catch(a){}},50);let ka=setInterval(()=>{C.readyState!=WebSocket.CLOSED&&(N?10<M&&(C.close(),location.reload(),clearInterval(ka)):(C.send(JSON.stringify(["ping"])),N=!0,ia=performance.now()),M++)},1E3);requestAnimationFrame(ha);
